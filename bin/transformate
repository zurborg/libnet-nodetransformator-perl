#!/usr/bin/perl -w

use Modern::Perl;
use Getopt::Long;
use POSIX qw(getcwd);
use Net::NodeTransformator;
use autodie;

my $host = 'localhost';
my $port = 12345;
my $sock;
my $engine = 'jade';
my $cbor;
my $yaml;
my $json;
my $data;
my $list;

GetOptions(
	"host=s" => \$host,
	"port=s" => \$port,
	"sock=s" => \$sock,
	"engine=s" => \$engine,
	"cbor=s" => \$cbor,
	"yaml=s" => \$yaml,
	"json=s" => \$json,
	"list" => \$list,
) or die "usage: $0 [--host <hostname>] [--port <tcp port>] [--sock <unix socket>] [--list] [--engine <engine name>] [--cbor <cbor file>] [--yaml <yaml file>] [--json <json file>] [<input file>]\n";

if ($sock) {
	$host = 'unix/';
	if ($sock !~ m{^/}) {
		$sock = join '/' => getcwd, $sock;
	}
	$port = $sock;
}

my $cli = new client("$host:$port");

if ($list) {
	say $cli->transform('list');
	exit;
}

if ($cbor) {
	require CBOR::XS;
	open CBOR, $cbor;
	$data = CBOR::XS::decode_cbor(join '' => <CBOR>);
	close CBOR;
}

if ($yaml) {
	require YAML::Any;
	$data = YAML::Any::LoadFile($yaml);
}

if ($json) {
	require JSON::Any;
	open JSON, $json;
	$data = JSON::Any->new->jsonToObj(join '' => <JSON>);
	close JSON;
}

my $inp = join '' => <>;

say $cli->transform($engine, $inp, $data);
